<!DOCTYPE html>
<html class="light" lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />

    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#39E079",
              "background-light": "#f6f8f7",
              "background-dark": "#122017",
            },
            fontFamily: { display: "Plus Jakarta Sans" },
            borderRadius: {
              DEFAULT: "0.5rem",
              lg: "1rem",
              xl: "1.5rem",
              full: "9999px",
            },
          },
        },
      };
    </script>

    <style type="text/tailwindcss">
      body {
        font-family: "Plus Jakarta Sans", "Noto Sans TC", sans-serif;
        min-height: max(884px, 100dvh);
      }
      .snow-bg {
        background: linear-gradient(180deg, #f6f7f8 0%, #eef6fc 100%);
      }
      .glass-effect {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(54, 164, 242, 0.1);
      }
      .custom-checkbox-tick:checked {
        background-image: url(https://lh3.googleusercontent.com/aida-public/AB6AXuCW1uRGFb2U_fWjuibbIwFGzdnzCMW2plnoF-UcdnSxv9cyX35ItvRiPOk1JlTurAiM3xjhTESA36_0ISyIZK2Z952BVYpYRYW0KhC_nvw608tPEV14j13uRdTkruBe5EARxf0j3FWMMuyqM-YeRF3BQNd9cPnS7jWHxhr2qkVBFCn1T_sU2ahq18B9PNh6rochfvn7cero7U7706Ke9RBGGc3fF8voiDy_neTzazuAnVNa-pk_GZVCjJMdxS03iCCE1cONd4SHeZU);
        background-size: 60%;
        background-position: center;
        background-repeat: no-repeat;
      }
      .strike-when-checked input:checked + span {
        text-decoration: line-through;
        opacity: 0.65;
      }
    </style>

    <title>北海道冬旅清單</title>
  </head>

  <body class="bg-background-light dark:bg-background-dark font-display text-[#0d161c] dark:text-slate-100">
    <div class="relative flex min-h-screen w-full flex-col max-w-md mx-auto overflow-x-hidden snow-bg dark:bg-background-dark">
      <!-- Header -->
      <header class="sticky top-0 z-20 glass-effect dark:bg-background-dark/80 px-4 py-4 flex items-center justify-between">
        <button
          class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-white/50 dark:hover:bg-slate-800 transition-colors"
          type="button"
          aria-label="返回"
          onclick="history.back()"
        >
          <span class="material-symbols-outlined">arrow_back_ios_new</span>
        </button>

        <h1 class="text-lg font-bold tracking-tight text-[#0d161c] dark:text-white">北海道冬旅清單</h1>

        <div class="flex items-center gap-2">
          <button
            id="themeToggle"
            class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/50 dark:hover:bg-slate-800 transition-colors"
            type="button"
            aria-label="切換深色模式"
            title="切換深色模式"
          >
            <span class="material-symbols-outlined text-primary">dark_mode</span>
          </button>
          <div class="w-10 h-10 flex items-center justify-center">
            <span class="material-symbols-outlined text-primary">ac_unit</span>
          </div>
        </div>
      </header>

      <!-- Main -->
      <main class="flex-1 pb-40">
        <!-- Progress card -->
        <div class="p-6">
          <div class="bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-blue-50 dark:border-slate-800">
            <div class="flex justify-between items-end mb-3">
              <div>
                <p class="text-sm text-[#4b799b] dark:text-slate-400 font-medium uppercase tracking-wider">完成進度</p>
                <p id="progressPercent" class="text-2xl font-bold text-[#0d161c] dark:text-white">0%</p>
              </div>
              <p id="remainingCount" class="text-xs text-[#4b799b] dark:text-slate-400 pb-1">還有 0 項待辦</p>
            </div>
            <div class="w-full bg-blue-50 dark:bg-slate-800 h-3 rounded-full overflow-hidden">
              <div
                id="progressBar"
                class="h-full bg-primary rounded-full shadow-[0_0_8px_rgba(54,164,242,0.5)] transition-all duration-500"
                style="width: 0%"
              ></div>
            </div>
          </div>
        </div>

        <!-- Sections -->
        <div id="sections" class="px-6 space-y-4"></div>
      </main>

      <!-- Floating add: 新增分類 -->
      <div class="fixed bottom-28 right-6 z-40">
        <button
          id="addSectionBtn"
          class="w-14 h-14 bg-primary text-white rounded-full shadow-lg shadow-primary/40 flex items-center justify-center active:scale-95 transition-transform"
          type="button"
          aria-label="新增分類"
          title="新增分類"
        >
          <span class="material-symbols-outlined text-3xl">add</span>
        </button>
      </div>

      <!-- Footer -->
      <footer
        class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md p-6 bg-gradient-to-t from-background-light via-background-light/95 to-transparent dark:from-background-dark dark:via-background-dark/95 dark:to-transparent z-30"
      >
        <button
          id="saveBtn"
          class="w-full h-14 bg-gradient-to-r from-primary to-[#5bbef7] text-white font-bold rounded-xl shadow-lg shadow-primary/30 active:scale-[0.98] transition-all flex items-center justify-center gap-2"
          type="button"
        >
          <span class="material-symbols-outlined">save</span>
          <span>儲存進度</span>
        </button>

        <p id="saveHint" class="text-center text-xs text-[#4b799b] dark:text-slate-400 mt-3"></p>
      </footer>
    </div>

    <script>
      /**
       * Data model:
       * {
       *   version: 1,
       *   title: "北海道冬旅清單",
       *   sections: [
       *     { id, name, icon, open, items: [{ id, text, done }] }
       *   ]
       * }
       */

      const STORAGE_KEY = "hokkaido_winter_checklist_v1";

      const DEFAULT_DATA = {
        version: 1,
        title: "北海道冬旅清單",
        sections: [
          {
            id: crypto.randomUUID(),
            name: "文件",
            icon: "description",
            open: true,
            items: [
              { id: crypto.randomUUID(), text: "護照正本", done: true },
              { id: crypto.randomUUID(), text: "機票確認單", done: true },
              { id: crypto.randomUUID(), text: "旅遊保險單", done: false },
              { id: crypto.randomUUID(), text: "JR Pass 兌換券", done: false },
            ],
          },
          {
            id: crypto.randomUUID(),
            name: "禦寒裝備",
            icon: "ac_unit",
            open: false,
            items: [
              { id: crypto.randomUUID(), text: "發熱衣 (Heattech)", done: false },
              { id: crypto.randomUUID(), text: "防水防滑雪靴", done: false },
              { id: crypto.randomUUID(), text: "保暖手套 & 圍巾", done: false },
            ],
          },
          {
            id: crypto.randomUUID(),
            name: "小孩用品",
            icon: "child_care",
            open: false,
            items: [
              { id: crypto.randomUUID(), text: "尿布 & 濕紙巾", done: false },
              { id: crypto.randomUUID(), text: "防風推車雨罩", done: false },
              { id: crypto.randomUUID(), text: "便攜式暖氣", done: false },
            ],
          },
          {
            id: crypto.randomUUID(),
            name: "電子產品",
            icon: "devices",
            open: false,
            items: [
              { id: crypto.randomUUID(), text: "行動電源", done: false },
              { id: crypto.randomUUID(), text: "萬用插頭", done: false },
            ],
          },
        ],
      };

      let state = loadState();

      // Theme init
      initTheme();

      // Render
      renderAll();

      // Events
      document.getElementById("saveBtn").addEventListener("click", () => {
        saveState(state);
        showSaveHint("已儲存 ✅");
      });

      document.getElementById("addSectionBtn").addEventListener("click", () => {
        const name = prompt("新增分類名稱：例如「藥品」、「住宿」、「行程」");
        if (!name) return;
        const icon = prompt("分類圖示（Material Symbols 名稱，可留空）：例如 'event', 'luggage'") || "list_alt";
        state.sections.unshift({
          id: crypto.randomUUID(),
          name: name.trim(),
          icon: icon.trim(),
          open: true,
          items: [],
        });
        renderAll();
        saveState(state);
        showSaveHint("已新增分類並自動儲存");
      });

      document.getElementById("themeToggle").addEventListener("click", () => {
        const root = document.documentElement;
        root.classList.toggle("dark");
        const isDark = root.classList.contains("dark");
        localStorage.setItem("pref_theme_dark", isDark ? "1" : "0");
      });

      // --------- Rendering ---------
      function renderAll() {
        // title
        document.title = state.title;
        // sections
        const container = document.getElementById("sections");
        container.innerHTML = "";

        for (const section of state.sections) {
          container.appendChild(renderSection(section));
        }

        updateProgressUI();
      }

      function renderSection(section) {
        const details = document.createElement("details");
        details.className =
          "group bg-white dark:bg-slate-900 rounded-xl border border-blue-50 dark:border-slate-800 shadow-sm overflow-hidden";
        details.open = !!section.open;

        details.addEventListener("toggle", () => {
          section.open = details.open;
          saveState(state);
        });

        // summary
        const summary = document.createElement("summary");
        summary.className = "flex items-center justify-between p-4 cursor-pointer list-none";

        const left = document.createElement("div");
        left.className = "flex items-center gap-3";

        const iconWrap = document.createElement("div");
        iconWrap.className =
          "w-8 h-8 rounded-lg bg-blue-50 dark:bg-slate-800 flex items-center justify-center text-primary";
        iconWrap.innerHTML = `<span class="material-symbols-outlined text-xl">${escapeHtml(section.icon)}</span>`;

        const title = document.createElement("span");
        title.className = "font-bold text-[#0d161c] dark:text-white";
        title.textContent = section.name;

        left.appendChild(iconWrap);
        left.appendChild(title);

        const right = document.createElement("div");
        right.className = "flex items-center gap-2";

        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className =
          "w-9 h-9 rounded-full hover:bg-blue-50 dark:hover:bg-slate-800 transition-colors flex items-center justify-center";
        delBtn.title = "刪除此分類";
        delBtn.innerHTML = `<span class="material-symbols-outlined text-[#4b799b] dark:text-slate-400">delete</span>`;
        delBtn.addEventListener("click", (e) => {
          e.preventDefault(); // prevent toggling details
          e.stopPropagation();
          if (!confirm(`確定刪除分類「${section.name}」？`)) return;
          state.sections = state.sections.filter((s) => s.id !== section.id);
          renderAll();
          saveState(state);
          showSaveHint("已刪除分類並儲存");
        });

        const chevron = document.createElement("span");
        chevron.className =
          "material-symbols-outlined text-[#4b799b] group-open:rotate-180 transition-transform duration-300";
        chevron.textContent = "expand_more";

        right.appendChild(delBtn);
        right.appendChild(chevron);

        summary.appendChild(left);
        summary.appendChild(right);

        // content
        const content = document.createElement("div");
        content.className = "p-4 pt-0 border-t border-blue-50 dark:border-slate-800 space-y-1";

        // items
        for (const item of section.items) {
          content.appendChild(renderItem(section, item));
        }

        // add row
        const addRow = document.createElement("div");
        addRow.className =
          "flex items-center gap-3 py-3 border-t border-dashed border-blue-100 dark:border-slate-800 mt-2";

        addRow.innerHTML = `
          <div class="flex items-center justify-center w-5 h-5 rounded-full border-2 border-dashed border-blue-200 text-blue-300">
            <span class="material-symbols-outlined text-xs">add</span>
          </div>
          <input class="flex-1 bg-transparent border-none p-0 text-base placeholder:text-blue-300/60 focus:ring-0 text-[#0d161c] dark:text-slate-200"
                 placeholder="新增自定義清單項目...（按 Enter）" type="text" />
        `;

        const input = addRow.querySelector("input");
        input.addEventListener("keydown", (e) => {
          if (e.key !== "Enter") return;
          const text = input.value.trim();
          if (!text) return;
          section.items.push({ id: crypto.randomUUID(), text, done: false });
          input.value = "";
          renderAll();
          saveState(state);
          showSaveHint("已新增項目並儲存");
        });

        content.appendChild(addRow);

        details.appendChild(summary);
        details.appendChild(content);
        return details;
      }

      function renderItem(section, item) {
        const label = document.createElement("label");
        label.className = "strike-when-checked flex items-center gap-3 py-3 group/item";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className =
          "custom-checkbox-tick h-5 w-5 rounded-full border-2 border-blue-200 text-primary focus:ring-primary/20 bg-transparent transition-all cursor-pointer";
        cb.checked = !!item.done;

        cb.addEventListener("change", () => {
          item.done = cb.checked;
          updateProgressUI();
          saveState(state);
        });

        const span = document.createElement("span");
        span.className = "text-base text-[#0d161c] dark:text-slate-200";
        span.textContent = item.text;

        const del = document.createElement("button");
        del.type = "button";
        del.className =
          "ml-auto w-9 h-9 rounded-full hover:bg-blue-50 dark:hover:bg-slate-800 transition-colors flex items-center justify-center";
        del.title = "刪除項目";
        del.innerHTML = `<span class="material-symbols-outlined text-[#4b799b] dark:text-slate-400 text-[20px]">close</span>`;
        del.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          section.items = section.items.filter((x) => x.id !== item.id);
          renderAll();
          saveState(state);
          showSaveHint("已刪除項目並儲存");
        });

        label.appendChild(cb);
        label.appendChild(span);
        label.appendChild(del);
        return label;
      }

      // --------- Progress ---------
      function updateProgressUI() {
        const allItems = state.sections.flatMap((s) => s.items);
        const total = allItems.length;
        const done = allItems.filter((i) => i.done).length;
        const remaining = Math.max(0, total - done);
        const percent = total === 0 ? 0 : Math.round((done / total) * 100);

        document.getElementById("progressPercent").textContent = `${percent}%`;
        document.getElementById("remainingCount").textContent = `還有 ${remaining} 項待辦`;
        document.getElementById("progressBar").style.width = `${percent}%`;
      }

      // --------- Storage ---------
      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return structuredClone(DEFAULT_DATA);
          const parsed = JSON.parse(raw);
          if (!parsed || !parsed.sections) return structuredClone(DEFAULT_DATA);
          return parsed;
        } catch {
          return structuredClone(DEFAULT_DATA);
        }
      }

      function saveState(s) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
        } catch {
          // ignore
        }
      }

      function showSaveHint(msg) {
        const el = document.getElementById("saveHint");
        el.textContent = msg;
        clearTimeout(showSaveHint._t);
        showSaveHint._t = setTimeout(() => (el.textContent = ""), 2000);
      }

      // --------- Theme ---------
      function initTheme() {
        const pref = localStorage.getItem("pref_theme_dark");
        const wantsDark = pref === "1";
        document.documentElement.classList.toggle("dark", wantsDark);
      }

      // --------- Utils ---------
      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
    </script>
  </body>
</html>
