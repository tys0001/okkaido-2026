<!DOCTYPE html>
<html class="light" lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#39E079",
              "background-light": "#f6f8f7",
              "background-dark": "#122017",
            },
            fontFamily: { display: ["Plus Jakarta Sans", "Noto Sans TC", "sans-serif"] },
            borderRadius: { DEFAULT: "0.5rem", lg: "1rem", xl: "1.5rem", full: "9999px" },
            boxShadow: {
              soft: "0 10px 30px rgba(2, 20, 10, 0.08)",
            },
          },
        },
      };
    </script>

    <style>
      body {
        min-height: max(884px, 100dvh);
      }
      .snow-bg {
        background: linear-gradient(180deg, #f6f7f8 0%, #eef6fc 100%);
      }
      .glass-effect {
        background: rgba(255, 255, 255, 0.72);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(54, 164, 242, 0.12);
      }
      .dark .glass-effect {
        background: rgba(18, 32, 23, 0.72);
        border-bottom: 1px solid rgba(148, 163, 184, 0.18);
      }
      .custom-checkbox-tick:checked {
        background-image: url(https://lh3.googleusercontent.com/aida-public/AB6AXuCW1uRGFb2U_fWjuibbIwFGzdnzCMW2plnoF-UcdnSxv9cyX35ItvRiPOk1JlTurAiM3xjhTESA36_0ISyIZK2Z952BVYpYRYW0KhC_nvw608tPEV14j13uRdTkruBe5EARxf0j3FWMMuyqM-YeRF3BQNd9cPnS7jWHxhr2qkVBFCn1T_sU2ahq18B9PNh6rochfvn7cero7U7706Ke9RBGGc3fF8voiDy_neTzazuAnVNa-pk_GZVCjJMdxS03iCCE1cONd4SHeZU);
        background-size: 60%;
        background-position: center;
        background-repeat: no-repeat;
      }
      .strike-when-checked input:checked + span {
        text-decoration: line-through;
        opacity: 0.65;
      }
      .chip {
        border: 1px solid rgba(54, 164, 242, 0.18);
      }
      .dark .chip {
        border: 1px solid rgba(148, 163, 184, 0.18);
      }
    </style>

    <title>北海道冬旅清單</title>
  </head>

  <body class="bg-background-light dark:bg-background-dark font-display text-[#0d161c] dark:text-slate-100">
    <div class="relative flex min-h-screen w-full flex-col max-w-md mx-auto overflow-x-hidden snow-bg dark:bg-background-dark">
      <!-- Header (箭頭已移除，標題置中) -->
      <header class="sticky top-0 z-30 glass-effect px-4 py-4 grid grid-cols-3 items-center">
        <div class="w-10 h-10"></div>

        <h1 class="text-lg font-bold tracking-tight text-[#0d161c] dark:text-white text-center">
          北海道冬旅清單
        </h1>

        <div class="flex items-center gap-2 justify-end">
          <button
            id="themeToggle"
            class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/50 dark:hover:bg-slate-800 transition-colors"
            type="button"
            aria-label="切換深色模式"
            title="切換深色模式"
          >
            <span class="material-symbols-outlined text-primary">dark_mode</span>
          </button>

          <button
            id="openSettings"
            class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/50 dark:hover:bg-slate-800 transition-colors"
            type="button"
            aria-label="開啟設定"
            title="設定"
          >
            <span class="material-symbols-outlined text-primary">tune</span>
          </button>
        </div>
      </header>

      <!-- Main -->
      <main class="flex-1 pb-44">
        <!-- Progress card -->
        <div class="p-6">
          <div class="bg-white dark:bg-slate-900 rounded-xl p-5 shadow-soft border border-blue-50 dark:border-slate-800">
            <div class="flex justify-between items-end mb-3">
              <div>
                <p class="text-sm text-[#4b799b] dark:text-slate-400 font-medium uppercase tracking-wider">完成進度</p>
                <p id="progressPercent" class="text-2xl font-bold text-[#0d161c] dark:text-white">0%</p>
              </div>
              <div class="text-right">
                <p id="remainingCount" class="text-xs text-[#4b799b] dark:text-slate-400 pb-1">還有 0 項待辦</p>
                <p id="autosaveStatus" class="text-[11px] text-[#4b799b] dark:text-slate-400">已儲存</p>
              </div>
            </div>
            <div class="w-full bg-blue-50 dark:bg-slate-800 h-3 rounded-full overflow-hidden">
              <div
                id="progressBar"
                class="h-full bg-primary rounded-full shadow-[0_0_8px_rgba(54,164,242,0.35)] transition-all duration-500"
                style="width: 0%"
              ></div>
            </div>

            <!-- Critical hint -->
            <div id="criticalHint" class="hidden mt-4 chip rounded-xl px-3 py-2 bg-blue-50/70 dark:bg-slate-800/60">
              <div class="flex items-start gap-2">
                <span class="material-symbols-outlined text-primary text-[20px] mt-[1px]">error</span>
                <div class="text-sm text-[#0d161c] dark:text-slate-200">
                  還有關鍵項目未完成（以「⭐」開頭）。建議出發前先確認。
                </div>
              </div>
            </div>

            <!-- Controls -->
            <div class="mt-4 flex flex-col gap-3">
              <div class="flex gap-2">
                <div class="relative flex-1">
                  <span
                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#4b799b] dark:text-slate-400 text-[20px]"
                    >search</span
                  >
                  <input
                    id="searchInput"
                    type="text"
                    placeholder="搜尋項目..."
                    class="w-full pl-10 pr-3 py-2 rounded-xl bg-white/70 dark:bg-slate-900 border border-blue-50 dark:border-slate-800 focus:ring-primary/20"
                  />
                </div>

                <button
                  id="addSectionBtnTop"
                  class="px-3 py-2 rounded-xl bg-primary text-white font-semibold shadow-lg shadow-primary/25 active:scale-[0.98] transition"
                  type="button"
                  title="新增分類"
                >
                  <span class="material-symbols-outlined align-middle text-[20px]">add</span>
                </button>
              </div>

              <div class="flex gap-2">
                <button data-filter="all" class="filterBtn chip flex-1 rounded-xl px-3 py-2 text-sm font-semibold bg-white/70 dark:bg-slate-900">
                  全部
                </button>
                <button data-filter="open" class="filterBtn chip flex-1 rounded-xl px-3 py-2 text-sm font-semibold bg-white/70 dark:bg-slate-900">
                  未完成
                </button>
                <button data-filter="done" class="filterBtn chip flex-1 rounded-xl px-3 py-2 text-sm font-semibold bg-white/70 dark:bg-slate-900">
                  已完成
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Sections -->
        <div id="sections" class="px-6 space-y-4"></div>
      </main>

      <!-- Floating add -->
      <div class="fixed bottom-28 right-6 z-40">
        <button
          id="addSectionBtn"
          class="w-14 h-14 bg-primary text-white rounded-full shadow-lg shadow-primary/40 flex items-center justify-center active:scale-95 transition-transform"
          type="button"
          aria-label="新增分類"
          title="新增分類"
        >
          <span class="material-symbols-outlined text-3xl">add</span>
        </button>
      </div>

      <!-- Footer -->
      <footer
        class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md p-6 bg-gradient-to-t from-background-light via-background-light/95 to-transparent dark:from-background-dark dark:via-background-dark/95 dark:to-transparent z-30"
      >
        <button
          id="saveBtn"
          class="w-full h-14 bg-gradient-to-r from-primary to-[#5bbef7] text-white font-bold rounded-xl shadow-lg shadow-primary/30 active:scale-[0.98] transition-all flex items-center justify-center gap-2"
          type="button"
        >
          <span class="material-symbols-outlined">save</span>
          <span>儲存進度</span>
        </button>
      </footer>

      <!-- Toast -->
      <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-24 z-50 hidden">
        <div class="px-4 py-2 rounded-full bg-[#0d161c] text-white text-sm shadow-lg">已儲存</div>
      </div>

      <!-- Settings Modal -->
      <div id="settingsModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] max-w-md">
          <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-soft border border-blue-50 dark:border-slate-800 overflow-hidden">
            <div class="p-4 flex items-center justify-between border-b border-blue-50 dark:border-slate-800">
              <div class="font-bold">設定</div>
              <button
                id="closeSettings"
                class="w-10 h-10 rounded-full hover:bg-blue-50 dark:hover:bg-slate-800 flex items-center justify-center"
              >
                <span class="material-symbols-outlined">close</span>
              </button>
            </div>

            <div class="p-4 space-y-3">
              <div class="chip rounded-xl p-3 bg-blue-50/60 dark:bg-slate-800/60">
                <div class="text-sm font-semibold mb-1">重置為預設清單</div>
                <div class="text-xs text-[#4b799b] dark:text-slate-400">
                  會清除目前所有勾選與自訂項目，回到預設清單（含關鍵駕照項目）。
                </div>
                <button
                  id="resetBtn"
                  class="mt-3 w-full rounded-xl px-3 py-2 bg-white dark:bg-slate-900 chip font-semibold"
                  type="button"
                >
                  重置
                </button>
              </div>

              <div class="chip rounded-xl p-3 bg-blue-50/60 dark:bg-slate-800/60">
                <div class="text-sm font-semibold mb-1">資料匯出 / 匯入</div>
                <div class="text-xs text-[#4b799b] dark:text-slate-400">可把整份清單資料複製備份或轉移到其他裝置。</div>
                <div class="flex gap-2 mt-3">
                  <button id="exportBtn" class="flex-1 rounded-xl px-3 py-2 bg-white dark:bg-slate-900 chip font-semibold" type="button">
                    匯出
                  </button>
                  <button id="importBtn" class="flex-1 rounded-xl px-3 py-2 bg-white dark:bg-slate-900 chip font-semibold" type="button">
                    匯入
                  </button>
                </div>
              </div>

              <div class="chip rounded-xl p-3 bg-blue-50/60 dark:bg-slate-800/60">
                <div class="text-sm font-semibold mb-1">提示</div>
                <div class="text-xs text-[#4b799b] dark:text-slate-400">
                  以「⭐」開頭的項目視為關鍵項目。若未完成，頂部會顯示提醒。
                </div>
              </div>
            </div>

            <div class="p-4 border-t border-blue-50 dark:border-slate-800 text-xs text-[#4b799b] dark:text-slate-400">
              本網站資料儲存在瀏覽器本機（localStorage）。
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const STORAGE_KEY = "hokkaido_winter_checklist_luxe_v2";

      const DEFAULT_DATA = {
        version: 2,
        title: "北海道冬旅清單",
        filter: "all",
        search: "",
        sections: [
          {
            id: crypto.randomUUID(),
            name: "文件",
            icon: "description",
            open: true,
            items: [
              { id: crypto.randomUUID(), text: "⭐ 台灣駕照正本＋日文譯本（缺一不可）", done: false },
              { id: crypto.randomUUID(), text: "護照正本", done: false },
              { id: crypto.randomUUID(), text: "機票確認單", done: false },
              { id: crypto.randomUUID(), text: "旅遊保險單", done: false },
            ],
          },
          {
            id: crypto.randomUUID(),
            name: "禦寒裝備",
            icon: "ac_unit",
            open: false,
            items: [
              { id: crypto.randomUUID(), text: "發熱衣 (Heattech)", done: false },
              { id: crypto.randomUUID(), text: "防水防滑雪靴", done: false },
              { id: crypto.randomUUID(), text: "保暖手套 & 圍巾", done: false },
            ],
          },
          {
            id: crypto.randomUUID(),
            name: "小孩用品",
            icon: "child_care",
            open: false,
            items: [
              { id: crypto.randomUUID(), text: "尿布 & 濕紙巾", done: false },
              { id: crypto.randomUUID(), text: "防風推車雨罩", done: false },
              { id: crypto.randomUUID(), text: "便攜式暖氣", done: false },
            ],
          },
          {
            id: crypto.randomUUID(),
            name: "電子產品",
            icon: "devices",
            open: false,
            items: [
              { id: crypto.randomUUID(), text: "行動電源", done: false },
              { id: crypto.randomUUID(), text: "萬用插頭", done: false },
            ],
          },
        ],
      };

      let state = loadState();

      initTheme();
      renderAll();

      // UI
      document.getElementById("saveBtn").addEventListener("click", () => {
        saveState(state);
        toast("已儲存");
      });

      document.getElementById("addSectionBtn").addEventListener("click", addSectionFlow);
      document.getElementById("addSectionBtnTop").addEventListener("click", addSectionFlow);

      document.getElementById("themeToggle").addEventListener("click", () => {
        const root = document.documentElement;
        root.classList.toggle("dark");
        const isDark = root.classList.contains("dark");
        localStorage.setItem("pref_theme_dark", isDark ? "1" : "0");
      });

      // Search
      const searchInput = document.getElementById("searchInput");
      searchInput.value = state.search || "";
      searchInput.addEventListener("input", () => {
        state.search = searchInput.value || "";
        saveState(state, { silent: true });
        renderAll();
      });

      // Filter buttons
      document.querySelectorAll(".filterBtn").forEach((btn) => {
        btn.addEventListener("click", () => {
          state.filter = btn.dataset.filter;
          saveState(state, { silent: true });
          renderAll();
        });
      });

      // Settings modal
      const settingsModal = document.getElementById("settingsModal");
      document.getElementById("openSettings").addEventListener("click", () => {
        settingsModal.classList.remove("hidden");
      });
      document.getElementById("closeSettings").addEventListener("click", () => {
        settingsModal.classList.add("hidden");
      });
      settingsModal.addEventListener("click", (e) => {
        if (e.target === settingsModal) settingsModal.classList.add("hidden");
      });

      // Reset
      document.getElementById("resetBtn").addEventListener("click", () => {
        if (!confirm("確定要重置為預設清單？目前資料會被清除。")) return;
        state = structuredClone(DEFAULT_DATA);
        saveState(state);
        settingsModal.classList.add("hidden");
        renderAll();
        toast("已重置");
      });

      // Export/Import
      document.getElementById("exportBtn").addEventListener("click", async () => {
        const text = JSON.stringify(state, null, 2);
        try {
          await navigator.clipboard.writeText(text);
          toast("已複製匯出資料");
        } catch {
          prompt("請手動複製以下內容：", text);
        }
      });

      document.getElementById("importBtn").addEventListener("click", () => {
        const raw = prompt("請貼上匯入資料（JSON）：");
        if (!raw) return;
        try {
          const parsed = JSON.parse(raw);
          if (!parsed || !Array.isArray(parsed.sections)) throw new Error("Invalid");
          state = parsed;
          normalizeState(state);
          saveState(state);
          settingsModal.classList.add("hidden");
          renderAll();
          toast("已匯入");
        } catch {
          alert("匯入失敗：資料格式不正確。");
        }
      });

      function renderAll() {
        document.querySelectorAll(".filterBtn").forEach((b) => {
          const active = b.dataset.filter === (state.filter || "all");
          b.classList.toggle("bg-primary", active);
          b.classList.toggle("text-white", active);
          b.classList.toggle("bg-white/70", !active);
          b.classList.toggle("dark:bg-slate-900", !active);
        });

        const container = document.getElementById("sections");
        container.innerHTML = "";
        for (const section of state.sections) container.appendChild(renderSection(section));
        updateProgressUI();
      }

      function renderSection(section) {
        const details = document.createElement("details");
        details.className =
          "group bg-white dark:bg-slate-900 rounded-xl border border-blue-50 dark:border-slate-800 shadow-soft overflow-hidden";
        details.open = !!section.open;

        details.addEventListener("toggle", () => {
          section.open = details.open;
          saveState(state, { silent: true });
        });

        const summary = document.createElement("summary");
        summary.className = "flex items-center justify-between p-4 cursor-pointer list-none";

        const left = document.createElement("div");
        left.className = "flex items-center gap-3 min-w-0";

        const iconWrap = document.createElement("div");
        iconWrap.className =
          "w-8 h-8 rounded-lg bg-blue-50 dark:bg-slate-800 flex items-center justify-center text-primary shrink-0";
        iconWrap.innerHTML = `<span class="material-symbols-outlined text-xl">${escapeHtml(section.icon)}</span>`;

        const title = document.createElement("div");
        title.className = "min-w-0";
        title.innerHTML = `
          <div class="font-bold text-[#0d161c] dark:text-white truncate">${escapeHtml(section.name)}</div>
          <div class="text-xs text-[#4b799b] dark:text-slate-400">
            ${countSectionOpenItems(section)} 項未完成 / 共 ${section.items.length} 項
          </div>
        `;

        left.appendChild(iconWrap);
        left.appendChild(title);

        const right = document.createElement("div");
        right.className = "flex items-center gap-1";

        const editBtn = iconButton("edit", "編輯分類");
        editBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          editSectionFlow(section);
        });

        const delBtn = iconButton("delete", "刪除此分類");
        delBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (!confirm(`確定刪除分類「${section.name}」？`)) return;
          state.sections = state.sections.filter((s) => s.id !== section.id);
          saveState(state);
          renderAll();
          toast("已刪除分類");
        });

        const chevron = document.createElement("span");
        chevron.className =
          "material-symbols-outlined text-[#4b799b] dark:text-slate-400 group-open:rotate-180 transition-transform duration-300 ml-1";
        chevron.textContent = "expand_more";

        right.appendChild(editBtn);
        right.appendChild(delBtn);
        right.appendChild(chevron);

        summary.appendChild(left);
        summary.appendChild(right);

        const content = document.createElement("div");
        content.className = "p-4 pt-0 border-t border-blue-50 dark:border-slate-800 space-y-1";

        const visibleItems = section.items.filter((item) => shouldShowItem(item, state.filter, state.search));
        if (visibleItems.length === 0) {
          const empty = document.createElement("div");
          empty.className = "py-4 text-sm text-[#4b799b] dark:text-slate-400";
          empty.textContent = "沒有符合條件的項目。";
          content.appendChild(empty);
        } else {
          for (const item of visibleItems) content.appendChild(renderItem(section, item));
        }

        const addRow = document.createElement("div");
        addRow.className =
          "flex items-center gap-3 py-3 border-t border-dashed border-blue-100 dark:border-slate-800 mt-2";

        addRow.innerHTML = `
          <div class="flex items-center justify-center w-5 h-5 rounded-full border-2 border-dashed border-blue-200 text-blue-300">
            <span class="material-symbols-outlined text-xs">add</span>
          </div>
          <input class="flex-1 bg-transparent border-none p-0 text-base placeholder:text-blue-300/60 focus:ring-0 text-[#0d161c] dark:text-slate-200"
                 placeholder="新增自定義清單項目...（按 Enter）" type="text" />
        `;

        const input = addRow.querySelector("input");
        input.addEventListener("keydown", (e) => {
          if (e.key !== "Enter") return;
          const text = input.value.trim();
          if (!text) return;
          section.items.push({ id: crypto.randomUUID(), text, done: false });
          input.value = "";
          saveState(state);
          renderAll();
          toast("已新增項目");
        });

        content.appendChild(addRow);

        details.appendChild(summary);
        details.appendChild(content);
        return details;
      }

      function renderItem(section, item) {
        const row = document.createElement("div");
        row.className = "flex items-center gap-2 py-2";

        const label = document.createElement("label");
        label.className = "strike-when-checked flex items-center gap-3 flex-1 min-w-0";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className =
          "custom-checkbox-tick h-5 w-5 rounded-full border-2 border-blue-200 text-primary focus:ring-primary/20 bg-transparent transition-all cursor-pointer shrink-0";
        cb.checked = !!item.done;

        cb.addEventListener("change", () => {
          item.done = cb.checked;
          saveState(state, { silent: true });
          renderAll();
        });

        const text = document.createElement("span");
        text.className = "text-base text-[#0d161c] dark:text-slate-200 truncate";
        text.textContent = item.text;
        text.title = item.text;
        text.addEventListener("dblclick", () => editItemFlow(item));

        label.appendChild(cb);
        label.appendChild(text);

        const edit = iconButton("edit", "編輯項目");
        edit.addEventListener("click", () => editItemFlow(item));

        const del = iconButton("close", "刪除項目");
        del.addEventListener("click", () => {
          section.items = section.items.filter((x) => x.id !== item.id);
          saveState(state);
          renderAll();
          toast("已刪除項目");
        });

        const isCritical = isCriticalItem(item);
        if (isCritical && !item.done) {
          const badge = document.createElement("div");
          badge.className =
            "chip text-[11px] px-2 py-1 rounded-full bg-blue-50/70 dark:bg-slate-800/60 text-[#0d161c] dark:text-slate-200 shrink-0";
          badge.textContent = "關鍵";
          row.appendChild(badge);
        }

        row.appendChild(label);
        row.appendChild(edit);
        row.appendChild(del);
        return row;
      }

      function shouldShowItem(item, filter, search) {
        const f = filter || "all";
        if (f === "open" && item.done) return false;
        if (f === "done" && !item.done) return false;

        const q = (search || "").trim().toLowerCase();
        if (!q) return true;
        return (item.text || "").toLowerCase().includes(q);
      }

      function isCriticalItem(item) {
        return typeof item.text === "string" && item.text.trim().startsWith("⭐");
      }

      function countSectionOpenItems(section) {
        return section.items.filter((i) => !i.done).length;
      }

      function updateProgressUI() {
        const allItems = state.sections.flatMap((s) => s.items);
        const total = allItems.length;
        const done = allItems.filter((i) => i.done).length;
        const remaining = Math.max(0, total - done);
        const percent = total === 0 ? 0 : Math.round((done / total) * 100);

        document.getElementById("progressPercent").textContent = `${percent}%`;
        document.getElementById("remainingCount").textContent = `還有 ${remaining} 項待辦`;
        document.getElementById("progressBar").style.width = `${percent}%`;

        const anyCriticalOpen = allItems.some((i) => isCriticalItem(i) && !i.done);
        document.getElementById("criticalHint").classList.toggle("hidden", !anyCriticalOpen);

        setAutosaveLabel("已儲存");
      }

      function addSectionFlow() {
        const name = prompt("新增分類名稱：");
        if (!name) return;
        const icon = prompt("分類圖示（Material Symbols 名稱，可留空）：", "list_alt") || "list_alt";
        state.sections.unshift({
          id: crypto.randomUUID(),
          name: name.trim(),
          icon: icon.trim(),
          open: true,
          items: [],
        });
        saveState(state);
        renderAll();
        toast("已新增分類");
      }

      function editSectionFlow(section) {
        const name = prompt("修改分類名稱：", section.name);
        if (name === null) return;
        const icon = prompt("修改分類圖示（Material Symbols 名稱）：", section.icon);
        if (icon === null) return;

        section.name = (name || "").trim() || section.name;
        section.icon = (icon || "").trim() || section.icon;

        saveState(state);
        renderAll();
        toast("已更新分類");
      }

      function editItemFlow(item) {
        const next = prompt("修改項目內容：", item.text);
        if (next === null) return;
        const trimmed = next.trim();
        if (!trimmed) return;
        item.text = trimmed;
        saveState(state);
        renderAll();
        toast("已更新項目");
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return structuredClone(DEFAULT_DATA);
          const parsed = JSON.parse(raw);
          if (!parsed || !Array.isArray(parsed.sections)) return structuredClone(DEFAULT_DATA);
          normalizeState(parsed);
          return parsed;
        } catch {
          return structuredClone(DEFAULT_DATA);
        }
      }

      function normalizeState(s) {
        s.version = s.version || 2;
        s.title = s.title || "北海道冬旅清單";
        s.filter = s.filter || "all";
        s.search = s.search || "";
        if (!Array.isArray(s.sections)) s.sections = [];
        for (const sec of s.sections) {
          sec.id = sec.id || crypto.randomUUID();
          sec.name = sec.name || "未命名分類";
          sec.icon = sec.icon || "list_alt";
          if (typeof sec.open !== "boolean") sec.open = false;
          if (!Array.isArray(sec.items)) sec.items = [];
          for (const it of sec.items) {
            it.id = it.id || crypto.randomUUID();
            it.text = it.text || "";
            it.done = !!it.done;
          }
        }
      }

      function saveState(s, opts = {}) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
          if (!opts.silent) toast("已儲存");
          setAutosaveLabel("已儲存");
        } catch {
          setAutosaveLabel("儲存失敗");
        }
      }

      function toast(msg) {
        const el = document.getElementById("toast");
        el.querySelector("div").textContent = msg;
        el.classList.remove("hidden");
        clearTimeout(toast._t);
        toast._t = setTimeout(() => el.classList.add("hidden"), 1400);
      }

      function setAutosaveLabel(text) {
        const el = document.getElementById("autosaveStatus");
        if (!el) return;
        el.textContent = text;
      }

      function iconButton(icon, title) {
        const b = document.createElement("button");
        b.type = "button";
        b.className =
          "w-9 h-9 rounded-full hover:bg-blue-50 dark:hover:bg-slate-800 transition-colors flex items-center justify-center";
        b.title = title;
        b.innerHTML = `<span class="material-symbols-outlined text-[#4b799b] dark:text-slate-400">${icon}</span>`;
        return b;
      }

      function initTheme() {
        const pref = localStorage.getItem("pref_theme_dark");
        const wantsDark = pref === "1";
        document.documentElement.classList.toggle("dark", wantsDark);
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
    </script>
  </body>
</html>
